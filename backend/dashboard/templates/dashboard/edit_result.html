<!doctype html>
<html>
  <head>
    <title>Edit Result - {{ competition.name }}</title>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      .form-container { border: 1px solid #ccc; padding: 20px; max-width: 600px; }
      .form-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
      .form-group label { flex: 0 0 120px; }
      .form-control { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
      .submit-button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
      .submit-button:hover { background-color: #218838; }
      .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
      .back-link:hover { text-decoration: underline; }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const DNF_KEYS = ["d", "D", "/", "#"];
        const DNS_KEYS = ["s", "S", "*"];

        const toInt = (input) => {
          const int = parseInt(input);
          return isNaN(int) ? null : int;
        };

        const toCentiseconds = (input) => {
          if (input === "") return 0;
          if (input === "DNF") return -1;
          if (input === "DNS") return -2;
          const num = toInt(input.replace(/\D/g, "")) || 0;
          return (
            Math.floor(num / 1000000) * 360000 +
            Math.floor((num % 1000000) / 10000) * 6000 +
            Math.floor((num % 10000) / 100) * 100 +
            (num % 100)
          );
        };

        const toClockFormat = (centiseconds) => {
          if (centiseconds === -1) return "DNF";
          if (centiseconds === -2) return "DNS";
          if (centiseconds == null || !Number.isFinite(centiseconds) || centiseconds < 0) {
             return "";
          }
          return new Date(centiseconds * 10)
            .toISOString()
            .substr(11, 11)
            .replace(/^[0:]*(?!\.)/g, "");
        };

        const reformatInput = (input) => {
          const number = toInt(input.replace(/\D/g, "")) || 0;
          if (number === 0) return "";
          const str = "00000000" + number.toString().slice(0, 8);
          const match = str.match(/(\d\d)(\d\d)(\d\d)(\d\d)$/);
          if (!match) return "";
          const [, hh, mm, ss, cc] = match;
          return `${hh}:${mm}:${ss}.${cc}`.replace(/^[0:]*(?!\.)/g, "");
        };

        const handleInput = (event) => {
          const input = event.target;
          const key = input.value.slice(-1);
          const hiddenInput = input.nextElementSibling;

          if (input.value.trim() === "") {
            hiddenInput.value = 0;
            input.value = "";
          } else if (DNF_KEYS.includes(key)) {
            input.value = "DNF";
            hiddenInput.value = -1;
          } else if (DNS_KEYS.includes(key)) {
            input.value = "DNS";
            hiddenInput.value = -2;
          } else {
            input.value = reformatInput(input.value);
            hiddenInput.value = toCentiseconds(input.value);
          }
        };

        const handleKeydown = (event) => {
          if (
            event.key === "Enter" ||
            event.key === "ArrowDown" ||
            event.key === "+"
          ) {
            event.preventDefault();
            const inputs = document.querySelectorAll(".time-input");
            const currentIndex = Array.from(inputs).indexOf(event.target);
            const nextInput = inputs[currentIndex + 1];
            if (nextInput) {
              nextInput.focus();
            } else {
              document.querySelector(".submit-button").focus();
            }
          } else if (event.key === "ArrowUp" || event.key === "-") {
            event.preventDefault();
            const inputs = document.querySelectorAll(".time-input");
            const currentIndex = Array.from(inputs).indexOf(event.target);
            const prevInput = inputs[currentIndex - 1];
            if (prevInput) {
              prevInput.focus();
            }
          }
        };

        const timeFields = ["time1", "time2", "time3", "time4", "time5"];
        timeFields.forEach((fieldName) => {
          const originalInput = document.querySelector(`#id_${fieldName}`);
          if (!originalInput) return;

          const displayInput = document.createElement("input");
          displayInput.type = "text";
          displayInput.className = "form-control time-input";
          displayInput.placeholder = "Enter time";
          displayInput.value = toClockFormat(parseInt(originalInput.value));


          originalInput.type = "hidden";

          originalInput.parentNode.insertBefore(displayInput, originalInput);

          displayInput.addEventListener("input", handleInput);
          displayInput.addEventListener("keydown", handleKeydown);
        });
      });
    </script>
  </head>
  <body>
    <a href="{% url 'dashboard:competition_detail' competition_id=competition.id %}" class="back-link">
      ‚Üê Back to {{ competition.name }}
    </a>
    <h2>Edit Result for {{ result.name }} in {{ competition.name }}</h2>

    <div class="form-container">
      <form method="POST">
        {% csrf_token %}
        {% for field in form %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
          {{ field }}
          {% if field.errors %}
            <div style="color: red;">
              {% for error in field.errors %}
                <small>{{ error }}</small>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        {% endfor %}
        <button type="submit" class="submit-button">Save Changes</button>
      </form>
    </div>
  </body>
</html>